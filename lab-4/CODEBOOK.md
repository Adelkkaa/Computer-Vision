## **Метод кодовой книги: теория, примеры и реализация**

---

### **1. Основная идея**
Метод кодовой книги (Codebook) — это более сложный и гибкий метод вычитания фона, который позволяет учитывать периодические изменения фона (например, качающиеся деревья или мигающие огни). Основная идея:
1. Для каждого пикселя создаётся **кодовая книга** — набор кластеров, которые описывают возможные значения пикселя в фоне.
2. На этапе обучения модель фона строится на основе анализа нескольких кадров.
3. На этапе вычитания фона проверяется, попадает ли текущий пиксель в один из кластеров фона. Если нет, он считается объектом переднего плана.

---

### **2. Математическая основа**

#### **2.1. Кодовая книга**
Для каждого пикселя создаётся кодовая книга, которая состоит из кластеров. Каждый кластер описывается следующими параметрами:
- **Среднее значение (mean)**: Среднее значение пикселя в кластере.
- **Минимальное значение (min)**: Нижняя граница кластера.
- **Максимальное значение (max)**: Верхняя граница кластера.
- **Частота (count)**: Количество раз, когда пиксель попадал в этот кластер.
- **Время последнего обновления (last_update)**: Время, когда кластер последний раз обновлялся.
- **Время неактивности (stale)**: Время, прошедшее с последнего обновления.

#### **2.2. Этап обучения**
На этапе обучения для каждого кадра проверяется, попадает ли текущий пиксель в один из существующих кластеров. Если да, кластер обновляется. Если нет, создаётся новый кластер.

#### **2.3. Этап вычитания фона**
На этапе вычитания фона проверяется, попадает ли текущий пиксель в один из кластеров фона. Если нет, он считается объектом переднего плана.

---

### **3. Пошаговый пример работы алгоритма**

Рассмотрим пример с одним пикселем для простоты. Пусть у нас есть видеопоследовательность из 5 кадров:

| Кадр | Значение пикселя |
|------|------------------|
| 1    | 100              |
| 2    | 102              |
| 3    | 101              |
| 4    | 105              |
| 5    | 110              |

#### **Шаг 1: Инициализация**
- Создаём пустую кодовую книгу для пикселя.

```python
codebook = []
```

---

#### **Шаг 2: Этап обучения**
- Для каждого кадра проверяем, попадает ли значение пикселя в один из существующих кластеров. Если нет, создаём новый кластер.

```python
for frame in frames:
    value = frame[pixel]
    found = False
    for cluster in codebook:
        if cluster['min'] <= value <= cluster['max']:
            # Обновляем кластер
            cluster['mean'] = (cluster['mean'] * cluster['count'] + value) / (cluster['count'] + 1)
            cluster['count'] += 1
            cluster['last_update'] = current_time
            found = True
            break
    if not found:
        # Создаём новый кластер
        new_cluster = {
            'mean': value,
            'min': value - 2,  # Примерное отклонение
            'max': value + 2,
            'count': 1,
            'last_update': current_time,
            'stale': 0
        }
        codebook.append(new_cluster)
```

| Кадр | Значение пикселя | Кодовая книга (кластеры) |
|------|------------------|--------------------------|
| 1    | 100              | [{'mean': 100, 'min': 98, 'max': 102, 'count': 1}] |
| 2    | 102              | [{'mean': 101, 'min': 98, 'max': 102, 'count': 2}] |
| 3    | 101              | [{'mean': 101, 'min': 98, 'max': 102, 'count': 3}] |
| 4    | 105              | [{'mean': 101, 'min': 98, 'max': 102, 'count': 3}, {'mean': 105, 'min': 103, 'max': 107, 'count': 1}] |
| 5    | 110              | [{'mean': 101, 'min': 98, 'max': 102, 'count': 3}, {'mean': 105, 'min': 103, 'max': 107, 'count': 1}, {'mean': 110, 'min': 108, 'max': 112, 'count': 1}] |

---

#### **Шаг 3: Этап вычитания фона**
- Проверяем, попадает ли текущее значение пикселя в один из кластеров фона. Если нет, это объект переднего плана.

```python
value = frame[pixel]
foreground = True
for cluster in codebook:
    if cluster['min'] <= value <= cluster['max']:
        foreground = False
        break
```

| Кадр | Значение пикселя | Объект переднего плана? |
|------|------------------|-------------------------|
| 1    | 100              | Нет                     |
| 2    | 102              | Нет                     |
| 3    | 101              | Нет                     |
| 4    | 105              | Нет                     |
| 5    | 110              | Да                      |

---

### **4. Полный код с комментариями**

```python
import cv2
import numpy as np

# Инициализация модели кодовой книги
fgbg = cv2.bgsegm.createBackgroundSubtractorCNT()

# Захват видеопоследовательности
cap = cv2.VideoCapture("video.mp4")

while cap.isOpened():
    ret, frame = cap.read()
    if not ret:
        break

    # Применение метода кодовой книги
    fg_mask = fgbg.apply(frame)

    # Отображение результата
    cv2.imshow("Original", frame)
    cv2.imshow("Foreground Mask", fg_mask)

    if cv2.waitKey(30) & 0xFF == ord('q'):
        break

cap.release()
cv2.destroyAllWindows()
```

---

### **5. Преимущества и недостатки**

#### **Преимущества**:
- Учитывает периодические изменения фона (например, качающиеся деревья).
- Гибкость: можно настраивать параметры кластеров.

#### **Недостатки**:
- Высокая вычислительная сложность.
- Требует больше памяти для хранения кодовой книги.
